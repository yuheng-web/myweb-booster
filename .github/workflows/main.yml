# This is a basic workflow to help you get started with Actions
name: PHP CI/CD

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  # workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  build-and-deploy:
    # The type of runner that the job will run on: ubuntu-latest or macos-11
    runs-on: macos-11

    env:
      COMPOSER_VERSION: 1

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@main
      # with:
      #   persist-credentials: false

      - name: Validate composer.json and composer.lock
        run: composer validate --strict

#      - name: Cache Composer packages
#        id: composer-cache
#        uses: actions/cache@v2
#        with:
#          path: vendor
#          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
#          restore-keys: |
#            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Validate depends
        run: composer depends --tree --version --no-cache

      - name: FTP to aliyun vh
        uses: SamKirkland/FTP-Deploy-Action@4.1.0
        with:
          server: ${{ secrets.ALIYUN_VH_HOST }}
          username: ${{ secrets.ALIYUN_VH_USERNAME }}
          password: ${{ secrets.ALIYUN_VH_PASSWORD }}
          local-dir: ./
          server-dir: htdocs/booster/
          dangerous-clean-slate: true
          dry-run: true # for testing

        # Add a test script to composer.json, for instance: "test": "vendor/bin/phpunit"
        # Docs: https://getcomposer.org/doc/articles/scripts.md
        # - name: Run test suite
        #   run: composer run-script test

